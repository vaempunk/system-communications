# Домашка урока 4 по курсу "Коммуникации систем"

## Опишите ADR, который проиллюстрирует причину изменения любой из коммуникаций

**ADR 1: Меняем eventual consistency между сервисом найма и сервисом бонусов**

**Status**: Proposed

**Context**.

Начисление бонусов менеджерам за выполненное задание зависит от рейтинга задания, который считается в сервисе найма по общему количеству правильных и неправильных ответов.

На момент принятия решения рейтинг задания передается в виде [COMM-060] события `TaskRating` в kafka, при выполнении задания кандидатом в учителя.

У бизнеса возникла проблема с данной реализацией: [Problem-030] Логика начисления бонусов некорректна из-за ошибки с рейтингом задания. Во время начисления бонусов во время изменения рейтинга, происходит задержка, которая не удовлетворяет бизнес (нужно моментально).

Проблема возникает из-за eventual consistency коммуникации, при асинхронной отправке события возникает задержка в обработке, и при зачислении сервис бонусов имеет неактуальный рейтинг.

**Decision**.

Меняем eventual consistency на strong consistency, заменив асинхронную связь на синхронную: вместо отправки события, при зачислении бонусов отправляем HTTP вызов из сервиса бонусов в сервис найма, в котором получим актуальный рейтинг. 

## Опишите, как почему возникла каждая из 10 проблем, которая возникла у бизнеса и как она будет решаться

Название проблемы | Из-за чего возникла проблема | Как проблема решилась
-- | -- | --
[Problem-010] Долго определяется правильность выполнения задания от кандидата. Это вызывает задержки, которые бесят менеджеров и кандидатов в учителя | При выполнении задания делаем 2 HTTP вызова: [COMM-030] (назначение менеджера), [COMM-040] (начисление бонусов) либо [COMM-050] (списание бонусов) | Заменяем синхронные вызовы на отправку событий в kafka: `TaskTooEasy` (задание требует переделки), `TaskCompleted`, `TaskFailed`
[Problem-020] Кандидаты в учителя читерят систему в месте, где простое задание должно усложниться, но этого ещё не произошло. Для этого они собираются в группы, где делятся лёгкими заданиями между собой, и, пока задание обновляется, пачкой выполняют лёгкие версии | Запрашиваем задание синхронным HTTP вызовом [COMM-020] из сервиса найма в сервис менеджмента при открытии заданий. Из-за этого на момент отправки решения задание уже может быть неактуальным | Заменяем pull HTTP вызов на push вызов - при изменении задания менеджером отправляем HTTP запрос в сервис найма с измененным заданием
[Problem-030] Логика начисления бонусов некорректна из-за ошибки с рейтингом задания. Во время начисления бонусов во время изменения рейтинга, происходит задержка, которая не удовлетворяет бизнес (нужно моментально) | При изменении рейтинга асинхронно отправляем [COMM-060] событие `TaskRating`. Из-за eventual consistency на момент зачисления бонусов может быть неактуальный рейтинг | Заменяем отправку события на HTTP вызов из сервиса бонусов в сервис найма, в котором получим актуальный рейтинг при зачислении бонусов
[Problem-040] Медленно начисляются бонусы менеджерам, потому что много кандидатов в учителя. Иногда вся система падает и не восстанавливается | Дудосим сервис бонусов HTTP вызовами [COMM-040], [COMM-050] из сервиса найма при выполнении заданий | Заменяем HTTP вызовы на асинхронную отправку событий
[Problem-050] В UI может отобразиться ошибка каких-то запросов после успешного выполнения задания. Разработчики объясняют это поведение вызовом сервиса оплаты и создания заданий | При выполнении задания делаем 2 HTTP вызова: [COMM-030], [COMM-040] либо [COMM-050], которые могут упасть | Заменяем HTTP вызовы на асинхронную отправку событий
[Problem-060] Нужно сократить расходы на скейлинг сервиса заданий. Сейчас дорого | При открытия задания каждый раз делается HTTP вызов [COMM-020] из сервиса найма в сервис менеджмента | Заменяем pull репликацию заданий на push, сократив нагрузку на сервис менеджмента
[Problem-070] Менеджерам иногда начисляются бонусы дважды. Это связано с тем, что, когда кандидаты в учителя отправляют то же самое задание повторно, система тупит [Problem-050]. Разработчики объясняют тем, что управление заданиями падает, а бонусами — нет. Из-за этого бонусы попадают в два одинаковых запроса | При выполнении задания делаем 2 HTTP вызова: [COMM-030], [COMM-040] либо [COMM-050] | Заменяем HTTP вызовы при выполнении заданий на асинхронную отправку событий
[Problem-080] Упавший сервис создания заданий или бонусов кладёт всю систему, и кандидаты в учителя не могут выполнять задания | При открытии задания делаем pull HTTP вызов [COMM-020] в сервис менеджмента; При выполнении задания делаем 2 HTTP вызова: [COMM-030], [COMM-040] либо [COMM-050] | Заменяем pull HTTP вызов на push из сервиса менеджмента; Заменяем HTTP вызовы при выполнении заданий на асинхронную отправку событий
[Problem-090] Фичи выходят слишком медленно. Это связано с тем, что для выполнения любой фичи нужно изучить всю систему и проверить, что ничего не упало. Короче, разработчики сами не понимают, как работает система вне отдельного сервиса. | Непонятны связи между сервисами, эволюция систем | Делаем ES, концептуальную модель данных, карту коммуникаций; Добавляем schema registry, стараемся соблюдать прямую и обратную совместимость, правильно именуем топики, события и HTTP эндпоинты
[Problem-100] Данные теряются вокруг логики выполнения заданий кандидатами в учителя | При выполнении задания делаем 2 HTTP вызова: [COMM-030], [COMM-040] либо [COMM-050], которые могут упасть | Заменяем HTTP вызовы при выполнении заданий на асинхронную отправку событий, добавляем ключ идемпотентности, dead letter queue и ретраи при отправке событий.